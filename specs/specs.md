# üèóÔ∏è MASTER SPECIFICATION : Plushies.dev

**Version :** 3.0 (Finale)
**Domaine :** [plushies.dev](https://www.google.com/search?q=https://plushies.dev)
**Objectif :** Cr√©er la r√©f√©rence collaborative des peluches et goodies Tech.
**Contrainte Budg√©taire :** 0‚Ç¨/mois (Free Tiers).

-----

## 1\. Architecture Technique (JAMstack Hybride)

  * **Frontend :** **Astro 5+** (Mode Static par d√©faut).
  * **Langage :** TypeScript (Strict mode).
  * **Styling :** Tailwind CSS.
  * **Interactivit√© :** React (via Astro Islands) pour les composants "Collection" et "Auth".
  * **Base de Donn√©es (Produits) :** Git / Markdown (Source de v√©rit√© statique).
  * **Base de Donn√©es (Utilisateurs) :** Supabase (PostgreSQL + Auth).
  * **H√©bergement & CI/CD :** Netlify.

-----

## 2\. Mod√®le de Donn√©es : Produits (Statique)

Les produits sont des fichiers Markdown stock√©s dans le repo Git : `src/content/plushies/*.md`.

**D√©finition du Sch√©ma (Zod) dans `src/content/config.ts` :**

```typescript
import { z, defineCollection } from 'astro:content';

const plushies = defineCollection({
  type: 'content',
  schema: ({ image }) => z.object({
    slug: z.string(),               // ID unique (ex: "rust-ferris")
    name: z.string(),               // Nom (ex: "Ferris The Crab")
    techs: z.array(z.string()),     // Cat√©gories (ex: ["Rust", "WASM"])
    official_link: z.string().url(),// Lien d'achat ou source
    image: image(),                 // Image locale optimis√©e par Astro
  }),
});

export const collections = { plushies };
```

-----

## 3\. Mod√®le de Donn√©es : Utilisateurs (Supabase)

**Instruction Devs :** Ex√©cuter ce script SQL complet dans l'√©diteur Supabase pour initialiser la DB et la S√©curit√© (RLS).

### Script SQL d'initialisation

```sql
-- A. CONFIGURATION DES TABLES
-- 1. Table PROFILES (Donn√©es publiques)
create table public.profiles (
  id uuid references auth.users not null primary key,
  username text unique,
  avatar_url text,
  updated_at timestamp with time zone,
  constraint username_length check (char_length(username) >= 3)
);

-- 2. Table USER_COLLECTIONS (Liaison User <-> Peluche)
create table public.user_collections (
  id bigint generated by default as identity primary key,
  user_id uuid references public.profiles(id) not null,
  plushie_slug text not null, -- Doit correspondre au slug Markdown
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  -- Un user ne peut pas avoir 2 fois la m√™me peluche
  constraint unique_collection_item unique (user_id, plushie_slug)
);

-- B. S√âCURIT√â (RLS - ROW LEVEL SECURITY)
alter table public.profiles enable row level security;
alter table public.user_collections enable row level security;

-- Policies pour PROFILES
create policy "Public profiles are viewable by everyone." 
  on public.profiles for select using ( true );

create policy "Users can update own profile." 
  on public.profiles for update using ( auth.uid() = id );

-- Policies pour USER_COLLECTIONS
create policy "Collections are viewable by everyone." 
  on public.user_collections for select using ( true );

create policy "Users can insert into own collection." 
  on public.user_collections for insert with check ( auth.uid() = user_id );

create policy "Users can delete from own collection." 
  on public.user_collections for delete using ( auth.uid() = user_id );

-- C. AUTOMATISATION (TRIGGER)
-- Cr√©e automatiquement le profil public quand un user se logue via GitHub
create or replace function public.handle_new_user()
returns trigger language plpgsql security definer set search_path = public
as $$
begin
  insert into public.profiles (id, username, avatar_url)
  values (
    new.id,
    new.raw_user_meta_data->>'user_name',
    new.raw_user_meta_data->>'avatar_url'
  );
  return new;
end;
$$;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
```

-----

## 4\. Le "Manifest Pattern" (Hydratation Client)

Pour que les pages dynamiques (Profils) puissent afficher les noms et images des produits sans acc√®s serveur, un index JSON doit √™tre g√©n√©r√© au moment du build.

  * **Script de Build :** G√©n√©rer `public/plushies-manifest.json`.
  * **Format JSON :**
    ```json
    {
      "rust-ferris": {
        "name": "Ferris",
        "techs": ["Rust", "WASM"],
        "image": "/_astro/ferris.hash.png"
      },
      "docker-whale": { ... }
    }
    ```

-----

## 5\. Routing & Strat√©gie de Rendu

### A. Pages Statiques (SSG)

*Pages g√©n√©r√©es en HTML au build time.*

  * `/` (Home) : Grille compl√®te, filtres via JS sur le DOM.
  * `/plushie/[slug]` (D√©tail) : Contenu Markdown.
      * Inclus : `<LikeButton client:load />` (Composant React connect√© √† Supabase).

### B. Pages Dynamiques (Client-Side Rewrite)

*Pages rendues par le navigateur (SPA) pour les profils utilisateurs.*

  * **Route Astro :** `src/pages/u/[username].astro`.
      * Squelette HTML vide (Loading skeleton).
      * Script JS :
        1.  Lit `username` dans l'URL.
        2.  Fetch `user_collections` depuis Supabase.
        3.  Fetch `plushies-manifest.json`.
        4.  Affiche la grille collection.
  * **Config Netlify :** N√©cessaire pour g√©rer les URLs dynamiques.
      * Fichier `public/_redirects` :
        ```text
        /u/* /u/index.html  200
        ```

-----

## 6\. Configuration Netlify (`netlify.toml`)

√Ä placer √† la racine du projet pour assurer le d√©ploiement correct.

```toml
[build]
  command = "npm run build"
  publish = "dist"

[functions]
  node_bundler = "esbuild"
```

-----

## 7\. Fonctionnalit√©s UX/UI

1.  **Authentification :**
      * Provider : **GitHub** uniquement.
      * Composant Navbar : Si non connect√© ‚Üí Bouton "Login". Si connect√© ‚Üí Avatar.
2.  **Gestion de Collection :**
      * **Optimistic UI :** Quand je clique sur "Je l'ai", le c≈ìur devient rouge imm√©diatement (avant la r√©ponse serveur).
      * Gestion d'erreur : Si non connect√©, afficher une modale/toast.
3.  **Partage (Social Proof) :**
      * Sur la page `/u/[username]`, bouton "Share on X" pr√©-rempli.
      * Score de collection (ex: nombre total d'items).

-----

## 8\. Workflow de D√©veloppement

1.  **Setup Env :** Cr√©er un fichier `.env` local :
    ```bash
    PUBLIC_SUPABASE_URL="https://xxx.supabase.co"
    PUBLIC_SUPABASE_ANON_KEY="eyJh..."
    ```
2.  **Ajout de Contenu :**
      * Cr√©er `src/content/plushies/new-plushie.md`.
      * Ajouter l'image dans `src/assets/`.
3.  **D√©ploiement :**
      * Commit & Push sur GitHub.
      * Netlify d√©tecte le changement et lance le Build.

-----

**Statut du document :** PR√äT POUR D√âVELOPPEMENT.